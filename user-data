#cloud-config

---
coreos:
  update:
    reboot-strategy: 'off'
  units:
  - name: appdb.service
    command: start
    enable: true
    content: |
      [Unit]
      Description=Application Postgresql Database
      Requires=docker.service data-persistent.mount
      After=docker.service data-persistent.mount

      [Service]
      ExecStartPre=-/usr/bin/docker kill appdb
      ExecStartPre=-/usr/bin/docker rm appdb
      ExecStartPre=/usr/bin/docker pull postgres:9.4
      ExecStartPre=-mkdir -p /data/persistent/fpg
      ExecStart=/usr/bin/docker run \
          --env POSTGRES_USER=postgres \
          --env POSTGRES_PASSWORD=p0stgres \
          --name appdb \
          --volume /data/persistent/fpg:/var/lib/postgresql/data \
          postgres:9.4
      ExecStop=/usr/bin/docker stop appdb

      [Install]
      WantedBy=multi-user.target
  - name: appdb-client.service
    command: stop
    enable: true
    content: |
      [Unit]
      Description=Application Database Client
      Requires=docker.service appdb.service
      After=docker.service appdb.service

      [Service]
      Type=oneshot
      ExecStart=/usr/bin/docker run --rm \
          --link appdb:appdb \
          --env PGUSER=postgres \
          --env PGPASSWORD=p0stgres \
          --env PGDATABASE=postgres \
          postgres:9.4 \
          psql -h appdb \
            --command="\\l"

      [Install]
      WantedBy=multi-user.target
  - name: create-raid-persistent-volume.service
    command: start
    content: |
      [Unit]
      Description=Create RAID for persistent volume
      After=dev-sdb.device dev-sdc.device dev-sdd.device

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/tmp/create-raid.sh /dev/md0 /dev/sdb /dev/sdc /dev/sdd
  - name: data-persistent.mount
    command: start
    content: |
      [Unit]
      Description=Mount persistent volume
      Requires=create-raid-persistent-volume.service
      After=create-raid-persistent-volume.service

      [Mount]
      What=/dev/disk/by-label/PERSISTENT
      Where=/data/persistent
      Type=ext4

      [Install]
      WantedBy=multi-user.target
write_files:
- path: "/tmp/create-raid.sh"
  permissions: '0700'
  content: |
    #!/bin/bash -eux
    CONF=/etc/mdadm.conf
    if [[ -e "${CONF}" ]]; then
      exit 0
    fi

    RAID_DEVICE=$1; shift
    DEVICES="$@"
    NDEVICES=$(echo "${DEVICES}" | wc -w)
    /usr/sbin/mdadm \
      --create "${RAID_DEVICE}" \
      --level=0 \
      --raid-devices=${NDEVICES} \
      ${DEVICES}

    echo "DEVICE partitions" > "${CONF}"
    /usr/sbin/mdadm --detail --scan >> "${CONF}"
    /usr/sbin/mkfs.ext4 -L PERSISTENT "${RAID_DEVICE}"
